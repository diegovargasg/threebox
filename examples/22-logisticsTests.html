<!doctype html>
<head>
	<title>Animated truck</title>
	<script src="../dist/threebox.js" type="text/javascript"></script>
	<link href="../dist/threebox.css" rel="stylesheet" />
	<script src="https://rawgithub.com/mrdoob/three.js/r104/examples/js/utils/BufferGeometryUtils.js"></script>
	<script src="config.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<style>
		body, html {
			width: 100%;
			height: 100%;
			margin: 0;
			background: black;
		}

		#map {
			width: 100%;
			height: 100%;
		}

		#explainer {
			z-index: 99;
		}
		#btns {
			right: 0;
			position: absolute;
			z-index: 100000;
		}
	</style>
</head>
<body>
	<div id='map' class='map'></div>
	<div id="btns">
		<button id="pauseBtn">Pause</button>
		<button id="continueBtn">Continue</button>
	</div>
	<div id='explainer'>Click on the map to drive the truck there</div>
	<script type="module">

		function pauseAnimation() {
			console.log("PAUSE")
			//truck.pause();
		}

		function continueAnimation() {
			console.log("CONTINUE");
			// truck.unPause();

			// const group = new THREE.Group();
			// group.updateMatrixWorld(true);
			// console.log(group)

			const truckSize = truck.getSize();
			const truck2Size = truck2.getSize();

			const truckGeometry = new THREE.BoxGeometry(truckSize.x, truckSize.y, truckSize.z);
			const truck2Geometry = new THREE.BoxGeometry(truck2Size.x, truck2Size.y, truck2Size.z);

			const mesh1 = new THREE.Mesh(truckGeometry, new THREE.MeshBasicMaterial({ color: 0xff0000 }));
			const mesh2 = new THREE.Mesh(truck2Geometry, new THREE.MeshBasicMaterial({ color: 0x00ff00 }));

			const mergedGeometry = new THREE.BoxGeometry();
			mergedGeometry.merge(truckGeometry, mesh1.matrix);
			mergedGeometry.merge(truck2Geometry, mesh2.matrix);

			const mergedMesh = new THREE.Mesh(mergedGeometry, new THREE.MeshBasicMaterial({ color: 0xffff00 }));

			const tmp = window.tb.Object3D({ obj: mergedMesh, scale: 1, units: "meters", bbox: false, rotation: { x: 0, y: 0, z: 0 }}).setCoords(origin);
			window.tb.add(tmp);

			// boxOjb = window.tb.Object3D({ obj: mesh1, scale: 1, units: "meters", bbox: false, rotation: { x: 0, y: 0, z: 0 }}).setCoords(origin);
			// boxOjb2 = window.tb.Object3D({ obj: mesh2, scale: 1, units: "meters", bbox: false, rotation: { x: 0, y: 0, z: 0 }}).setCoords(origin2);



			// let boxModel = new THREE.Box3Helper(bb, Objects.prototype._defaults.colors.yellow);
			
// console.log(group);
			//window.tb.add(boxOjb);

			// const groupBoundingBox = new THREE.Box3().setFromObject(group);
			// const boxHelper = new THREE.Box3Helper(groupBoundingBox, 0xffff00);

			// truckGeometry.toBufferGeometry();
			// Create a buffer geometry from each geometry
			// const bufferGeometry1 = new THREE.BufferGeometry().fromGeometry(truckGeometry);
			// const bufferGeometry2 = new THREE.BufferGeometry().fromGeometry(truck2Geometry);

			// const mergedGeometry = THREE.BufferGeometryUtils.mergeBufferGeometries([bufferGeometry1, bufferGeometry2]);

			// const redMaterial = new THREE.MeshPhongMaterial({ color: 0x660000, opacity: 0.5, transparent: true });
			// const boxMesh = new THREE.Mesh(mergedGeometry, redMaterial);
			// boxOjb = window.tb.Object3D({ obj: boxMesh, scale: 1, units: "meters", bbox: false, rotation: { x: 0, y: 0, z: 0 }}).setCoords(origin);
			// window.tb.add(boxOjb);
/*
			const redMaterial = new THREE.MeshPhongMaterial({ color: 0x660000, opacity: 0.5, transparent: true });
			const box3 = truck.box3();
			box3.expandByObject(truck);

			const box3Size = new THREE.Vector3();
			const size = box3.getSize(box3Size); 
			
			// const boxSize = box3.getSize(box3Size);
			
			// console.log(boxSize)

			// const box3Size = truck.getSize();
			const boxGeometry = new THREE.BoxGeometry(size.x, size.y, size.z);
			const boxMesh = new THREE.Mesh(boxGeometry, redMaterial);
			boxOjb = window.tb.Object3D({ obj: boxMesh, scale: 1, units: "meters", bbox: false, rotation: { x: 0, y: 0, z: 0 }}).setCoords(origin);

			// boxGeometry.expandByObject(truck);

			window.tb.add(boxOjb);*/
		}

		function followAuto() {
			console.log("FollowAuto");
		}

		function generateToolTip() {
			const toolTipHtml = `<div><button onclick="${followAuto}">Follow</button><button>Park</button><button>Continue</button></div>`;
			return toolTipHtml;
		}

		// This example downloads a truck model from an external OBJ/MTL file, adds it to the map, and drives it around via paths fetched from the Mapbox Directions API

		if (!config) console.error("Config not set! Make a copy of 'config_template.js', add in your access token, and save the file as 'config.js'.");

		mapboxgl.accessToken = config.accessToken;

		var origin = [13.401095791729222, 52.51906775178806];
		var origin2 = [-122.43369451186717, 37.73498937816123];
		var destination, line;
		var truck, boxOjb, boxOjb2, truck2;

		document.getElementById("pauseBtn").addEventListener("click", pauseAnimation);
		document.getElementById("continueBtn").addEventListener("click", continueAnimation);

		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/dark-v9',
			center: origin,
			zoom: 16,
			pitch: 60,
			bearing: 90,
			antialias: true
		});

		let stats;
		import Stats from 'https://threejs.org/examples/jsm/libs/stats.module.js';
		function animate() {
			requestAnimationFrame(animate);
			stats.update();
		}

		map.on('style.load', function () {
			// stats
			stats = new Stats();
			map.getContainer().appendChild(stats.dom);
			animate();

			map.addLayer({
					id: 'custom_layer',
					type: 'custom',
					renderingMode: '3d',
					onAdd: function (map, mbxContext) {

						window.tb = new Threebox(
							map,
							mbxContext,
							{
								defaultLights: true,
								enableSelectingObjects: true,
								enableTooltips: true
							}
						);

						// Royalty Free License: Vehicles by https://www.cgtrader.com/antonmoek
						// from https://www.cgtrader.com/free-3d-models/car/concept/cartoon-low-poly-city-cars-pack
						var options = {
							type: 'gltf',
							obj: 'models/vehicles/truck.glb',
							scale: 40,
							units: 'meters',
							anchor: "bottom",
							rotation: { x: 90, y: 90, z: 0 }, //rotation to postiion the truck and heading properly

						}

						tb.loadObj(options, function (model) {

							truck = model.setCoords(origin)
							// truck.addTooltip(generateToolTip(), true);
							truck.addEventListener('click', (e) => {
								console.log(e);
								

								// e.detail.expandByObject(geo);
							});
							truck.addEventListener('hover', (e) => {
								if(e.detail.isRunning) {
									e.detail.pause();
								}
							});

							truck.addEventListener('unhover', (e) => {
								if(e.detail.isRunning === false) { 
									e.detail.unPause();
								}
							});
							tb.add(truck);
						});

						tb.loadObj(options, function (model) {
							// Second truck
							truck2 = model.setCoords(origin2)
							// truck.addTooltip(generateToolTip(), true);
							truck2.addEventListener('click', (e) => {
								console.log(e);
								// e.detail.expandByObject(geo);
							});
							truck2.addEventListener('hover', (e) => {
								if(e.detail.isRunning) {
									e.detail.pause();
								}
							});

							truck2.addEventListener('unhover', (e) => {
								if(e.detail.isRunning === false) { 
									e.detail.unPause();
								}
							});
							//tb.add(truck2);
						});
					},

					render: function (gl, matrix) {
						tb.update();
					}
			});
		})
		.on('click', function (e) {
			console.log(e)
			var pt = [e.lngLat.lng, e.lngLat.lat];
			travelPath(pt);
		})
		
		map.on('SelectedFeatureChange', (e) => {console.log(e)});

		function onObjectChanged(e) {
			let model = e.detail.object; //here's the object already modified
			let action = e.detail.action; //here's the action that changed the object
			// console.log(action);
		}

		function travelPath(destination) {

			// request directions. See https://docs.mapbox.com/api/navigation/#directions for details

			var url = "https://api.mapbox.com/directions/v5/mapbox/driving/" + [origin, destination].join(';') + "?geometries=geojson&access_token=" + config.accessToken


			fetchFunction(url, function (data) {

				// extract path geometry from callback geojson, and set duration of travel
				var options = {
					path: data.routes[0].geometry.coordinates,
					duration: 10000
				}

				// start the truck animation with above options, and remove the line when animation ends
				truck.followPath(
					options,
					function () {
						tb.remove(line);
					}
				);

				// set up geometry for a line to be added to map, lofting it up a bit for *style*
				// var lineGeometry = options.path
				// 	.map(function (coordinate) {
				// 		return coordinate.concat([15])
				// 	})

				// create and add line object
				line = tb.line({
					geometry: options.path,
					width: 5,
					color: 'steelblue'
				})

				tb.add(line);

				// set destination as the new origin, for the next trip
				origin = destination;

			})
		}

		//convenience function for fetch

		function fetchFunction(url, cb) {
			const data = {
    "routes": [
        {
            "weight_name": "auto",
            "weight": 257.75,
            "duration": 188.299,
            "distance": 738.31,
            "legs": [
                {
                    "via_waypoints": [],
                    "admins": [
                        {
                            "iso_3166_1_alpha3": "USA",
                            "iso_3166_1": "US"
                        }
                    ],
                    "weight": 257.75,
                    "duration": 188.299,
                    "steps": [],
                    "distance": 738.31,
                    "summary": "Diamond Street, Bosworth Street"
                }
            ],
            "geometry": {
                "coordinates": [
                    [
                        -122.433915,
                        37.735338
                    ],
                    [
                        -122.433774,
                        37.735139
                    ],
                    [
                        -122.43373,
                        37.734984
                    ],
                    [
                        -122.434138,
                        37.733604
                    ],
                    [
                        -122.438258,
                        37.73438
                    ],
                    [
                        -122.438701,
                        37.734507
                    ],
                    [
                        -122.439345,
                        37.734776
                    ],
                    [
                        -122.439808,
                        37.734872
                    ],
                    [
                        -122.439994,
                        37.734875
                    ]
                ],
                "type": "LineString"
            }
        }
    ],
    "waypoints": [
        {
            "distance": 8.553,
            "name": "Diamond Street",
            "location": [
                -122.433915,
                37.735338
            ]
        },
        {
            "distance": 2.628,
            "name": "Bosworth Street",
            "location": [
                -122.439994,
                37.734875
            ]
        }
    ],
    "code": "Ok",
    "uuid": "bY_boeRl2y7vNY4ilRtCrkKzoKiGfKCUVskf1h_gmH8v7GKxzT04kg=="
};
			/*fetch(url)
				.then(
					function (response) {
						if (response.status === 200) {
							response.json()
								.then(function (data) {
									cb(data)
								})
						}
					}
				)*/
			cb(data);
		}
	</script>
</body>